{% extends 'base.html' %}

{% block extra_head %}
<style>
    .container {
        max-width: 900px;
        margin: 2em auto;
        padding: 2em;
    }
    .form-container {
        background: #fff;
        border-radius: 8px;
        padding: 2em;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h2 {
        color: #2c3e50;
        margin-bottom: 1.5em;
    }
    .form-group {
        margin-bottom: 1.5em;
    }
    label {
        display: block;
        margin-bottom: 0.5em;
        color: #34495e;
        font-weight: 600;
    }
    input[type="text"],
    input[type="number"],
    select {
        width: 100%;
        padding: 0.8em;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1em;
        box-sizing: border-box;
    }
    input:focus, select:focus {
        outline: none;
        border-color: #1abc9c;
    }
    .btn {
        display: inline-block;
        padding: 0.8em 1.5em;
        background: #1abc9c;
        color: #fff;
        text-decoration: none;
        border-radius: 5px;
        transition: background 0.3s;
        font-weight: 600;
        border: none;
        cursor: pointer;
        margin-right: 1em;
    }
    .btn:hover {
        background: #16a085;
    }
    .btn-secondary {
        background: #95a5a6;
    }
    .btn-secondary:hover {
        background: #7f8c8d;
    }
    .btn-small {
        padding: 0.5em 1em;
        font-size: 0.9em;
    }
    .button-group {
        margin-top: 2em;
    }
    .items-section {
        background: #f8f9fa;
        padding: 1.5em;
        border-radius: 5px;
        margin: 2em 0;
    }
    .items-section h3 {
        margin-top: 0;
        color: #2c3e50;
    }
    .item-row {
        display: grid;
        grid-template-columns: 2fr 1fr auto;
        gap: 1em;
        margin-bottom: 1em;
        align-items: end;
    }
    .total-section {
        background: #e8f4f2;
        padding: 1em;
        border-radius: 5px;
        margin-top: 1.5em;
        text-align: right;
    }
    .total-section h3 {
        margin: 0;
        color: #2c3e50;
    }
</style>
<script>
    function addItemRow() {
        const container = document.getElementById('items-container');
        const newRow = document.createElement('div');
        newRow.className = 'item-row';
        newRow.innerHTML = `
            <div class="form-group" style="margin-bottom: 0;">
                <label>Food Item</label>
                <select name="food_items[]" required>
                    <option value="">-- Select Item --</option>
                    {% for item in food_items %}
                    <option value="{{ item.id }}" data-price="{{ item.price }}">{{ item.name }} - Rs{{ item.price }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label>Quantity</label>
                <input type="number" name="quantities[]" min="1" value="1" required>
            </div>
            <button type="button" class="btn btn-danger btn-small" onclick="removeItemRow(this)">Remove</button>
        `;
        container.appendChild(newRow);
        updateTotal();
    }

    function removeItemRow(button) {
        button.parentElement.remove();
        updateTotal();
    }

    function updateTotal() {
        let foodTotal = 0;
        const rows = document.querySelectorAll('.item-row');
        rows.forEach(row => {
            const select = row.querySelector('select[name="food_items[]"]');
            const quantity = row.querySelector('input[name="quantities[]"]');
            if (select && quantity && select.value) {
                const price = parseFloat(select.options[select.selectedIndex].getAttribute('data-price') || 0);
                foodTotal += price * parseInt(quantity.value || 0);
            }
        });
        
        // Get room charge if room is selected
        const roomSelect = document.getElementById('id_room');
        let roomCharge = 0;
        if (roomSelect && roomSelect.value) {
            const selectedOption = roomSelect.options[roomSelect.selectedIndex];
            roomCharge = parseFloat(selectedOption.getAttribute('data-price') || 0);
        }
        
        const total = foodTotal + roomCharge;
        document.getElementById('total_amount').value = total.toFixed(2);
        document.getElementById('room_charge_display').textContent = 'Rs' + roomCharge.toFixed(2);
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('items-container').addEventListener('change', updateTotal);
        document.getElementById('id_room').addEventListener('change', updateTotal);
        updateTotal();
    });
</script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="form-container">
        <h2>Create New Sales Bill</h2>
        <form method="post">
            {% csrf_token %}
            
            <div class="form-group">
                <label for="id_guest_name">Guest Name *</label>
                {{ form.guest_name }}
            </div>

            <div class="form-group">
                <label for="id_room">Room (Optional)</label>
                <select id="id_room" name="room">
                    <option value="">-- No Room Selected --</option>
                    {% for room in rooms %}
                    <option value="{{ room.id }}" data-price="{{ room.price_per_night }}">
                        Room {{ room.number }} ({{ room.get_room_type_display }}) - Rs{{ room.price_per_night }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="items-section">
                <h3>Order Items</h3>
                <div id="items-container">
                    <div class="item-row">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Food Item</label>
                            <select name="food_items[]" required>
                                <option value="">-- Select Item --</option>
                                {% for item in food_items %}
                                <option value="{{ item.id }}" data-price="{{ item.price }}">{{ item.name }} - Rs{{ item.price }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Quantity</label>
                            <input type="number" name="quantities[]" min="1" value="1" required>
                        </div>
                        <button type="button" class="btn btn-danger btn-small" onclick="removeItemRow(this)">Remove</button>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary btn-small" onclick="addItemRow()">+ Add Another Item</button>
            </div>

            <div class="total-section">
                <h3 style="margin-top: 0; color: #2c3e50;">Bill Summary</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em; margin-bottom: 1.5em;">
                    <div style="text-align: left;">
                        <p style="color: #7f8c8d; margin: 0.5em 0;">Room Charge:</p>
                        <p style="font-size: 1.1em; color: #2c3e50;">
                            <span id="room_charge_display">Rs0.00</span>
                        </p>
                    </div>
                    <div style="text-align: right;">
                        <p style="color: #7f8c8d; margin: 0.5em 0;">Total Amount:</p>
                        <p style="font-size: 1.3em; color: #1abc9c; font-weight: bold;">Rs<input type="number" id="total_amount" name="total_amount" step="0.01" value="0.00" style="width: 150px; display: inline-block; padding: 0.3em; border: none; background: transparent; text-align: right;" required readonly></p>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button type="submit" class="btn">Create Bill</button>
                <a href="{% url 'sales_bill_list' %}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}
