{% extends 'base.html' %}

{% block extra_head %}
<style>
    .container {
        max-width: 900px;
        margin: 2em auto;
        padding: 2em;
    }
    .form-container {
        background: #fff;
        border-radius: 8px;
        padding: 2em;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h2 {
        color: #2c3e50;
        margin-bottom: 1.5em;
    }
    .form-group {
        margin-bottom: 1.5em;
    }
    label {
        display: block;
        margin-bottom: 0.5em;
        color: #34495e;
        font-weight: 600;
    }
    input[type="text"],
    input[type="number"],
    select {
        width: 100%;
        padding: 0.8em;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1em;
        box-sizing: border-box;
    }
    input:focus, select:focus {
        outline: none;
        border-color: #1abc9c;
    }
    .btn {
        display: inline-block;
        padding: 0.8em 1.5em;
        background: #1abc9c;
        color: #fff;
        text-decoration: none;
        border-radius: 5px;
        transition: background 0.3s;
        font-weight: 600;
        border: none;
        cursor: pointer;
        margin-right: 1em;
    }
    .btn:hover {
        background: #16a085;
    }
    .btn-secondary {
        background: #95a5a6;
    }
    .btn-secondary:hover {
        background: #7f8c8d;
    }
    .btn-small {
        padding: 0.5em 1em;
        font-size: 0.9em;
    }
    .button-group {
        margin-top: 2em;
    }
    .items-section {
        background: #f8f9fa;
        padding: 1.5em;
        border-radius: 5px;
        margin: 2em 0;
    }
    .items-section h3 {
        margin-top: 0;
        color: #2c3e50;
    }
    .item-row {
        display: grid;
        grid-template-columns: 2fr 1fr auto;
        gap: 1em;
        margin-bottom: 1em;
        align-items: end;
    }
    .total-section {
        background: #e8f4f2;
        padding: 1em;
        border-radius: 5px;
        margin-top: 1.5em;
        text-align: right;
    }
    .total-section h3 {
        margin: 0;
        color: #2c3e50;
    }
</style>
<script>
    function addItemRow() {
        const container = document.getElementById('items-container');
        const newRow = document.createElement('div');
        newRow.className = 'item-row';
        newRow.innerHTML = `
            <div class="form-group" style="margin-bottom: 0;">
                <label>Food Item</label>
                <select name="food_items[]" required>
                    <option value="">-- Select Item --</option>
                    {% for item in food_items %}
                    <option value="{{ item.id }}" data-price="{{ item.price }}">{{ item.name }} - Rs{{ item.price }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label>Quantity</label>
                <input type="number" name="quantities[]" min="1" value="1" required>
            </div>
            <button type="button" class="btn btn-danger btn-small" onclick="removeItemRow(this)">Remove</button>
        `;
        container.appendChild(newRow);
        updateTotal();
    }

    function removeItemRow(button) {
        button.parentElement.remove();
        updateTotal();
    }

    function updateTotal() {
        let foodTotal = 0;
        const rows = document.querySelectorAll('.item-row');
        rows.forEach(row => {
            const select = row.querySelector('select[name="food_items[]"]');
            const quantity = row.querySelector('input[name="quantities[]"]');
            if (select && quantity && select.value) {
                const price = parseFloat(select.options[select.selectedIndex].getAttribute('data-price') || 0);
                foodTotal += price * parseInt(quantity.value || 0);
            }
        });
        
        // Get room charge if room is selected
        const roomSelect = document.getElementById('id_room');
        let roomCharge = 0;
        if (roomSelect && roomSelect.value) {
            const selectedOption = roomSelect.options[roomSelect.selectedIndex];
            roomCharge = parseFloat(selectedOption.getAttribute('data-price') || 0);
        }
        
        // Calculate subtotal before discount
        const subtotal = foodTotal + roomCharge;
        document.getElementById('subtotal_display').textContent = 'Rs' + subtotal.toFixed(2);
        
        // Apply discount
        const discountPercentage = parseFloat(document.getElementById('discount_percentage').value || 0);
        const discountAmount = (subtotal * discountPercentage) / 100;
        document.getElementById('discount_amount').value = discountAmount.toFixed(2);
        document.getElementById('discount_display').textContent = 'Rs' + discountAmount.toFixed(2) + ' (' + discountPercentage + '%)';
        
        // Calculate final total
        const total = subtotal - discountAmount;
        document.getElementById('total_amount').value = total.toFixed(2);
        document.getElementById('room_charge_display').textContent = 'Rs' + roomCharge.toFixed(2);
        
        // Update remaining amount for payment
        updatePaymentRemaining();
    }

    function addPaymentRow() {
        const container = document.getElementById('payments-container');
        const newRow = document.createElement('div');
        newRow.className = 'item-row';
        newRow.innerHTML = `
            <div class="form-group" style="margin-bottom: 0;">
                <label>Payment Method</label>
                <select name="payment_methods[]" required onchange="updatePaymentRemaining()">
                    <option value="">-- Select Method --</option>
                    <option value="cash">Cash</option>
                    <option value="card">Card</option>
                    <option value="online">Online</option>
                    <option value="upi">UPI</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label>Amount</label>
                <input type="number" name="payment_amounts[]" step="0.01" min="0" required oninput="updatePaymentRemaining()">
            </div>
            <button type="button" class="btn btn-danger btn-small" onclick="removePaymentRow(this)">Remove</button>
        `;
        container.appendChild(newRow);
        updatePaymentRemaining();
    }

    function removePaymentRow(button) {
        button.parentElement.remove();
        updatePaymentRemaining();
    }

    function updatePaymentRemaining() {
        const totalAmount = parseFloat(document.getElementById('total_amount').value || 0);
        let paidAmount = 0;
        
        const paymentRows = document.querySelectorAll('#payments-container .item-row');
        paymentRows.forEach(row => {
            const amountInput = row.querySelector('input[name="payment_amounts[]"]');
            if (amountInput && amountInput.value) {
                paidAmount += parseFloat(amountInput.value || 0);
            }
        });
        
        const remaining = totalAmount - paidAmount;
        document.getElementById('paid_amount_display').textContent = 'Rs' + paidAmount.toFixed(2);
        document.getElementById('remaining_display').textContent = 'Rs' + remaining.toFixed(2);
        
        // Change color based on payment status
        const remainingElement = document.getElementById('remaining_display');
        if (remaining < 0) {
            remainingElement.style.color = '#e74c3c'; // Red for overpayment
        } else if (remaining === 0) {
            remainingElement.style.color = '#27ae60'; // Green for fully paid
        } else {
            remainingElement.style.color = '#f39c12'; // Orange for pending
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('items-container').addEventListener('change', updateTotal);
        document.getElementById('id_room').addEventListener('change', updateTotal);
        document.getElementById('discount_percentage').addEventListener('input', updateTotal);
        updateTotal();
    });
</script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="form-container">
        <h2>Create New Sales Bill</h2>
        <form method="post">
            {% csrf_token %}
            
            <div class="form-group">
                <label for="id_guest_name">Guest Name *</label>
                {{ form.guest_name }}
            </div>

            <div class="form-group">
                <label for="id_room">Room (Optional)</label>
                <select id="id_room" name="room">
                    <option value="">-- No Room Selected --</option>
                    {% for room in rooms %}
                    <option value="{{ room.id }}" data-price="{{ room.price_per_night }}">
                        Room {{ room.number }} ({{ room.get_room_type_display }}) - {{ room.get_status_display }} - Rs{{ room.price_per_night }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="items-section">
                <h3>Order Items</h3>
                <div id="items-container">
                    <div class="item-row">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Food Item</label>
                            <select name="food_items[]" required>
                                <option value="">-- Select Item --</option>
                                {% for item in food_items %}
                                <option value="{{ item.id }}" data-price="{{ item.price }}">{{ item.name }} - Rs{{ item.price }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Quantity</label>
                            <input type="number" name="quantities[]" min="1" value="1" required>
                        </div>
                        <button type="button" class="btn btn-danger btn-small" onclick="removeItemRow(this)">Remove</button>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary btn-small" onclick="addItemRow()">+ Add Another Item</button>
            </div>

            <div class="form-group">
                <label for="discount_percentage">Discount (%)</label>
                <input type="number" id="discount_percentage" name="discount_percentage" min="0" max="100" step="0.01" value="0" style="width: 200px;">
            </div>

            <div class="items-section" style="margin-top: 2em;">
                <h3>Payment Methods</h3>
                <p style="color: #7f8c8d; font-size: 0.9em; margin-bottom: 1em;">Add one or more payment methods (split payments allowed)</p>
                <div id="payments-container">
                    <div class="item-row">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Payment Method</label>
                            <select name="payment_methods[]" required onchange="updatePaymentRemaining()">
                                <option value="">-- Select Method --</option>
                                <option value="cash" selected>Cash</option>
                                <option value="card">Card</option>
                                <option value="online">Online</option>
                                <option value="upi">UPI</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Amount</label>
                            <input type="number" name="payment_amounts[]" step="0.01" min="0" required oninput="updatePaymentRemaining()">
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary btn-small" onclick="addPaymentRow()" style="margin-top: 1em;">+ Add Another Payment Method</button>
            </div>

            <div class="total-section">
                <h3 style="margin-top: 0; color: #2c3e50;">Bill Summary</h3>
                <div style="text-align: right; font-size: 1em;">
                    <p style="color: #7f8c8d; margin: 0.5em 0;">Room Charge: <span id="room_charge_display" style="color: #2c3e50; font-weight: 600;">Rs0.00</span></p>
                    <p style="color: #7f8c8d; margin: 0.5em 0;">Subtotal: <span id="subtotal_display" style="color: #2c3e50; font-weight: 600;">Rs0.00</span></p>
                    <p style="color: #7f8c8d; margin: 0.5em 0;">Discount: <span id="discount_display" style="color: #e74c3c; font-weight: 600;">Rs0.00 (0%)</span></p>
                    <input type="hidden" id="discount_amount" name="discount_amount" value="0.00">
                    <hr style="border: none; border-top: 2px solid #ddd; margin: 1em 0;">
                    <p style="color: #7f8c8d; margin: 0.5em 0;">Total Amount:</p>
                    <p style="font-size: 1.5em; color: #1abc9c; font-weight: bold; margin: 0.5em 0;">Rs<input type="number" id="total_amount" name="total_amount" step="0.01" value="0.00" style="width: 150px; display: inline-block; padding: 0.3em; border: none; background: transparent; text-align: right; font-size: 1em; color: #1abc9c; font-weight: bold;" required readonly></p>
                    <hr style="border: none; border-top: 1px dashed #ddd; margin: 1em 0;">
                    <p style="color: #7f8c8d; margin: 0.5em 0;">Paid Amount: <span id="paid_amount_display" style="color: #27ae60; font-weight: 600;">Rs0.00</span></p>
                    <p style="color: #7f8c8d; margin: 0.5em 0;">Remaining: <span id="remaining_display" style="color: #f39c12; font-weight: 600; font-size: 1.1em;">Rs0.00</span></p>
                </div>
            </div>

            <div class="button-group">
                <button type="submit" class="btn">Create Bill</button>
                <a href="{% url 'sales_bill_list' %}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}
